---
title: "接口时间优化"
date: 2021-12-07 17:22:30
draft: true
tags: [PHP, 接口时间]
categories:
- [PHP, 接口时间]
---

> 背景，接口执行时间大概60秒左右，时间太长了



表结构

```sql
create table adjust_price
(
    id              bigint unsigned auto_increment
        primary key,
    name            varchar(20)  default '' not null comment '调价单名称',
    start_at        datetime                null comment '调价开始时间',
    end_at          datetime                null comment '调价结束时间',
    description     varchar(500) default '' not null comment '调价单描述',
    sell_channel_id int unsigned default 0  not null comment '销售渠道id',
    create_by       int unsigned default 0  not null comment '创建人',
    update_by       int unsigned default 0  not null comment '更新人',
    created_at      timestamp               null,
    updated_at      timestamp               null,
    deleted_at      timestamp               null
)
    comment '调价单主表' collate = utf8mb4_unicode_ci;
```

```sql
create table adjust_price_product_sku_store
(
    id              bigint unsigned auto_increment
        primary key,
    adjust_price_id int unsigned   default 0    not null comment '调价单id',
    sell_channel_id int unsigned   default 0    not null comment '销售渠道id',
    sku_id          int unsigned   default 0    not null comment '渠道skuId',
    promotion_price decimal(10, 2) default 0.00 not null comment '促销价',
    store_id        int unsigned   default 0    not null comment '门店id',
    start_at        datetime                    null comment '调价开始时间',
    end_at          datetime                    null comment '调价结束时间',
    created_at      timestamp                   null,
    updated_at      timestamp                   null,
    deleted_at      timestamp                   null
)
    comment '调价单子表' collate = utf8mb4_unicode_ci;



```

skuId数量M = 100, storeId的数量N = 450，那么子表adjust_price_product_sku_store每次插入的数据会有 M*N条，大概45000条。
detail 接口常规做法，通过做法通过with把子表带出来
```php
AdjustPrice::whereId($id)->with(['adjustPriceStoreGroup', 'adjustPriceProductSkuStore'])->first();

```
但是，这样带出的数据会特别多，时间大概10s，数据大小大概 11Mb，外加一些逻辑处理接口的整体响应时间大概25s左右，用户体验特别不好。思路进行数量级降级处理，把 `M*N` 的数量级，变成 `M+N` 的数量级

最终效果：
```
时间从  20 秒 降到了 1秒
数据从11Mb 降到了 400Kb
```
查询一条数据 ，可以获取到

```php
$adjustPriceProductSkuStore = app(AdjustPriceProductSkuStoreRepository::class)->getByAdjustPriceIdLimitOne($adjustPrice->id);


select sku_id, store_id from adjust_price_product_sku_store limit 1;
```


// 通过第一条记录，找出来一个storeId，通过storeId获取所有的skuIds
```php
$adjustPriceProductSkuStoresToGetSkuIds = app(AdjustPriceProductSkuStoreRepository::class)->list([
    'adjustPriceId' => $adjustPrice->id,
    'storeId'       => $adjustPriceProductSkuStore->store_id,
]);
```

// 通过第一条记录，找出来一个skuId，通过skuId获取所有的storeIds

```php

$adjustPriceProductSkuStoresToGetStoreIds = app(AdjustPriceProductSkuStoreRepository::class)->list([
    'adjustPriceId' => $adjustPrice->id,
    'skuId'         => $adjustPriceProductSkuStore->sku_id,
]);

```